# The MIT License (MIT)
# Copyright © 2024 Eclipse Vortex

# Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
# documentation files (the “Software”), to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,
# and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all copies or substantial portions of
# the Software.

# THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
# THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# DEALINGS IN THE SOFTWARE.
import os
import sys
import fcntl
import json
import signal
from collections import defaultdict
from flask import Flask, render_template, jsonify, request

from subnet.firewall.firewall_factory import create_firewall_tool

app = Flask(__name__)

DEVELOPMENT = False


def load_events():
    if not DEVELOPMENT:
        events = []
        if not os.path.exists("firewall-events.json"):
            return events

        # Write event to file
        with open("firewall-events.json", "r") as file:
            try:
                fcntl.flock(file, fcntl.LOCK_EX)

                for line in file:
                    events.append(json.loads(line))
            finally:
                fcntl.flock(file, fcntl.LOCK_UN)

        return events
    return [
        {
            "request_id": "8d632720-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "1 None False",
            "process_time": 0.0011339187622070312,
            "notified": False,
            "current_time": 1720712709.1304789,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 48124,
            "flags": "S",
            "seq": 2735023456,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "8d632720-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "2 None True",
            "process_time": 0.0004928112030029297,
            "notified": True,
            "current_time": 1720712710.3438416,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 48124,
            "flags": "PA",
            "seq": 2735023457,
            "ack": 3832825427,
            "payload": "UE9TVCAvUW5BVGFzayBIVFRQLzEuMQ0KSG9zdDogMTY3Ljg2Ljc5Ljg2OjgwOTENCm5hbWU6IFFuQVRhc2sNCnRpbWVvdXQ6IDEyLjANCmJ0X2hlYWRlcl9heG9uX2lwOiAxNjcuODYuNzkuODYNCmJ0X2hlYWRlcl9heG9uX3BvcnQ6IDgwOTENCmJ0X2hlYWRlcl9heG9uX2hvdGtleTogNUNxdzNHcDNLMmpMR0JEZFJGZGRUMjlnS0w0eGRSeTY1RlVwYVFiS1VOUGhzU1F0DQpidF9oZWFkZXJfZGVuZHJpdGVfaXA6IDE5Mi4xNTAuMjUzLjEyMg0KYnRfaGVhZGVyX2RlbmRyaXRlX3ZlcnNpb246IDcyMA0KYnRfaGVhZGVyX2RlbmRyaXRlX25vbmNlOiAyNTgzOTY0MTkxMjEzMjQNCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAxODMwZTliNi0zZDQzLTExZWYtYjRkNy1lN2IwMmJlZDJiNTcNCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVFMld1OFNzcEZIZEtlMUJSdmZNNUNwU3hjalFmenBReFlLR1ZFWUs1Mkc0bWJEdg0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHg3YTQxNzRmNWU1NDczZmY3ZDE3ZTlmODQ4OWE2ZDI0MjVhZTAxYzU1MzlhMmQxMGViMGYyYmI2ZDVhYWI3MjUwYTA1NDZlMzU3ODc4MTRlZGIzMzc4MWUzZWRkMWFmNWFhZWE0ZTUxODM1Y2ZhMTk3NGZlZWFjMTMyYTc4Mzk4Ng0KaGVhZGVyX3NpemU6IDY0MA0KdG90YWxfc2l6ZTogODI4MQ0KY29tcHV0ZWRfYm9keV9oYXNoOiBhN2ZmYzZmOGJmMWVkNzY2NTFjMTQ3NTZhMDYxZDY2MmY1ODBmZjRkZTQzYjQ5ZmE4MmQ4MGE0YjgwZjg0MzRhDQpBY2NlcHQ6ICovKg0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlLCBicg0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuMGIwDQpDb250ZW50LUxlbmd0aDogMTI4NQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "deny",
            "type": "deny",
            "reason": "Synapse name 'QnATask' not found, available ['Synapse', 'Score']",
            "synapse": "QnATask",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5Cqw3Gp3K2jLGBDdRFddT29gKL4xdRy65FUpaQbKUNPhsSQt",
            },
            "dendrite": {
                "ip": "192.150.253.122",
                "port": None,
                "hotkey": "5E2Wu8SspFHdKe1BRvfM5CpSxcjQfzpQxYKGVEYK52G4mbDv",
                "signature": "0x7a4174f5e5473ff7d17e9f8489a6d2425ae01c5539a2d10eb0f2bb6d5aab7250a0546e35787814edb33781e3edd1af5aaea4e51835cfa1974feeac132a783986",
                "nonce": 258396419121324,
                "uuid": "1830e9b6-3d43-11ef-b4d7-e7b02bed2b57",
                "version": 720,
                "neuron_version": None,
            },
        },
        {
            "request_id": "956e4af8-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "8d632720-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0032014846801757812,
            "notified": False,
            "current_time": 1720712722.625007,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 21488,
            "flags": "S",
            "seq": 1074722671,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "b03708e8-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "956e4af8-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0025904178619384766,
            "notified": False,
            "current_time": 1720712767.5616024,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 24413,
            "flags": "S",
            "seq": 3988838246,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "b03708e8-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "956e4af8-3f9c-11ef-b64f-9dc9db5f9ad8 2 False",
            "process_time": 0.00035262107849121094,
            "notified": False,
            "current_time": 1720712768.5864353,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 24413,
            "flags": "PA",
            "seq": 3988838247,
            "ack": 2963119452,
            "payload": "UE9TVCAvUW5BVGFzayBIVFRQLzEuMQ0KSG9zdDogMTY3Ljg2Ljc5Ljg2OjgwOTENCm5hbWU6IFFuQVRhc2sNCnRpbWVvdXQ6IDEyLjANCmJ0X2hlYWRlcl9heG9uX2lwOiAxNjcuODYuNzkuODYNCmJ0X2hlYWRlcl9heG9uX3BvcnQ6IDgwOTENCmJ0X2hlYWRlcl9heG9uX2hvdGtleTogNUNxdzNHcDNLMmpMR0JEZFJGZGRUMjlnS0w0eGRSeTY1RlVwYVFiS1VOUGhzU1F0DQpidF9oZWFkZXJfZGVuZHJpdGVfaXA6IDE5Mi4xNTAuMjUzLjEyMg0KYnRfaGVhZGVyX2RlbmRyaXRlX3ZlcnNpb246IDcyMA0KYnRfaGVhZGVyX2RlbmRyaXRlX25vbmNlOiAyNTg0NTU4NzQwMTAxNTUNCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAxODMwZTliNi0zZDQzLTExZWYtYjRkNy1lN2IwMmJlZDJiNTcNCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVFMld1OFNzcEZIZEtlMUJSdmZNNUNwU3hjalFmenBReFlLR1ZFWUs1Mkc0bWJEdg0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHg5NjdkZmM2MWNiMDQzZjliNWQ0ZTY1MzI0OWMwMDhhZjU5YTkzNDU0YjFmMGQxMTRhYzBkMzVhMWY1MGFkYTAyN2RjMDkzNzJiMGEzZDZhOWZiNGU4YjRhYzVmYTY3Y2ZiNjk2N2QxZDNlNTAwNDNjYmFmMTYxYWQ3MThiOGE4NA0KaGVhZGVyX3NpemU6IDY0MA0KdG90YWxfc2l6ZTogODgxOQ0KY29tcHV0ZWRfYm9keV9oYXNoOiBhN2ZmYzZmOGJmMWVkNzY2NTFjMTQ3NTZhMDYxZDY2MmY1ODBmZjRkZTQzYjQ5ZmE4MmQ4MGE0YjgwZjg0MzRhDQpBY2NlcHQ6ICovKg0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlLCBicg0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuMGIwDQpDb250ZW50LUxlbmd0aDogMjI5NQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "deny",
            "type": "deny",
            "reason": "Synapse name 'QnATask' not found, available ['Synapse', 'Score']",
            "synapse": "QnATask",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5Cqw3Gp3K2jLGBDdRFddT29gKL4xdRy65FUpaQbKUNPhsSQt",
            },
            "dendrite": {
                "ip": "192.150.253.122",
                "port": None,
                "hotkey": "5E2Wu8SspFHdKe1BRvfM5CpSxcjQfzpQxYKGVEYK52G4mbDv",
                "signature": "0x967dfc61cb043f9b5d4e653249c008af59a93454b1f0d114ac0d35a1f50ada027dc09372b0a3d6a9fb4e8b4ac5fa67cfb6967d1d3e50043cbaf161ad718b8a84",
                "nonce": 258455874010155,
                "uuid": "1830e9b6-3d43-11ef-b4d7-e7b02bed2b57",
                "version": 720,
                "neuron_version": None,
            },
        },
        {
            "request_id": "b8928ba2-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "b03708e8-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.004004955291748047,
            "notified": False,
            "current_time": 1720712781.5829954,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 52179,
            "flags": "S",
            "seq": 3138099946,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "b8928ba2-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "b03708e8-3f9c-11ef-b64f-9dc9db5f9ad8 2 False",
            "process_time": 0.00037097930908203125,
            "notified": False,
            "current_time": 1720712781.9907906,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 52179,
            "flags": "PA",
            "seq": 3138099947,
            "ack": 206807982,
            "payload": "UE9TVCAvUW5BUmVzdWx0IEhUVFAvMS4xDQpIb3N0OiAxNjcuODYuNzkuODY6ODA5MQ0KbmFtZTogUW5BUmVzdWx0DQp0aW1lb3V0OiA1LjANCmJ0X2hlYWRlcl9heG9uX2lwOiAxNjcuODYuNzkuODYNCmJ0X2hlYWRlcl9heG9uX3BvcnQ6IDgwOTENCmJ0X2hlYWRlcl9heG9uX2hvdGtleTogNUNxdzNHcDNLMmpMR0JEZFJGZGRUMjlnS0w0eGRSeTY1RlVwYVFiS1VOUGhzU1F0DQpidF9oZWFkZXJfZGVuZHJpdGVfaXA6IDE5Mi4xNTAuMjUzLjEyMg0KYnRfaGVhZGVyX2RlbmRyaXRlX3ZlcnNpb246IDcyMA0KYnRfaGVhZGVyX2RlbmRyaXRlX25vbmNlOiAyNTg0NzAwNjY3NjA4NTQNCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAxODMwZTliNi0zZDQzLTExZWYtYjRkNy1lN2IwMmJlZDJiNTcNCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVFMld1OFNzcEZIZEtlMUJSdmZNNUNwU3hjalFmenBReFlLR1ZFWUs1Mkc0bWJEdg0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHgwYTY5ZTdkZjg2ODM5ZjA1ZjNlZjQ2MDZkNjNjMjZiOGViYjQ0Mjg4NTlkN2ExOTFmNjU2YTk0MWUxZjE0NDAxNmI1MDA5ZTRjNjFmOTE2NTk4ODE0ZWUzOTVhOTA3ZGIxZDdlOTI4YTNjZTk1YjkyMjI3OWZiM2M2ZjIzN2Y4ZQ0KYnRfaGVhZGVyX2lucHV0X29ial9yZXN1bHRzOiBJaUk9DQpoZWFkZXJfc2l6ZTogNjQwDQp0b3RhbF9zaXplOiA0NTEwDQpjb21wdXRlZF9ib2R5X2hhc2g6IGE3ZmZjNmY4YmYxZWQ3NjY1MWMxNDc1NmEwNjFkNjYyZjU4MGZmNGRlNDNiNDlmYTgyZDgwYTRiODBmODQzNGENCkFjY2VwdDogKi8qDQpBY2NlcHQtRW5jb2Rpbmc6IGd6aXAsIGRlZmxhdGUsIGJyDQpVc2VyLUFnZW50OiBQeXRob24vMy4xMCBhaW9odHRwLzMuOS4wYjANCkNvbnRlbnQtTGVuZ3RoOiAyMDM5DQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb24NCg0K",
            "status": "deny",
            "type": "deny",
            "reason": "Synapse name 'QnAResult' not found, available ['Synapse', 'Score']",
            "synapse": "QnAResult",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5Cqw3Gp3K2jLGBDdRFddT29gKL4xdRy65FUpaQbKUNPhsSQt",
            },
            "dendrite": {
                "ip": "192.150.253.122",
                "port": None,
                "hotkey": "5E2Wu8SspFHdKe1BRvfM5CpSxcjQfzpQxYKGVEYK52G4mbDv",
                "signature": "0x0a69e7df86839f05f3ef4606d63c26b8ebb4428859d7a191f656a941e1f144016b5009e4c61f916598814ee395a907db1d7e928a3ce95b922279fb3c6f237f8e",
                "nonce": 258470066760854,
                "uuid": "1830e9b6-3d43-11ef-b4d7-e7b02bed2b57",
                "version": 720,
                "neuron_version": None,
            },
        },
        {
            "request_id": "c0383e88-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "b8928ba2-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0026595592498779297,
            "notified": False,
            "current_time": 1720712794.4130743,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 14828,
            "flags": "S",
            "seq": 4218073615,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "c0383e88-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "b8928ba2-3f9c-11ef-b64f-9dc9db5f9ad8 2 False",
            "process_time": 0.0003457069396972656,
            "notified": False,
            "current_time": 1720712795.114165,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 14828,
            "flags": "PA",
            "seq": 4218073616,
            "ack": 4222276532,
            "payload": "UE9TVCAvUW5BVGFzayBIVFRQLzEuMQ0KSG9zdDogMTY3Ljg2Ljc5Ljg2OjgwOTENCm5hbWU6IFFuQVRhc2sNCnRpbWVvdXQ6IDEyLjANCmJ0X2hlYWRlcl9heG9uX2lwOiAxNjcuODYuNzkuODYNCmJ0X2hlYWRlcl9heG9uX3BvcnQ6IDgwOTENCmJ0X2hlYWRlcl9heG9uX2hvdGtleTogNUNxdzNHcDNLMmpMR0JEZFJGZGRUMjlnS0w0eGRSeTY1RlVwYVFiS1VOUGhzU1F0DQpidF9oZWFkZXJfZGVuZHJpdGVfaXA6IDE5Mi4xNTAuMjUzLjEyMg0KYnRfaGVhZGVyX2RlbmRyaXRlX3ZlcnNpb246IDcyMA0KYnRfaGVhZGVyX2RlbmRyaXRlX25vbmNlOiAyNTg0ODE1NDI1NDYwOTQNCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAxODMwZTliNi0zZDQzLTExZWYtYjRkNy1lN2IwMmJlZDJiNTcNCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVFMld1OFNzcEZIZEtlMUJSdmZNNUNwU3hjalFmenBReFlLR1ZFWUs1Mkc0bWJEdg0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHhhNDBjYTQxOThkOThhNzUxN2M4ZWY5YzU4NzE2MmM4NTc4Mzk2YTA0NDgwODg4ZDM5OTBhZjRlM2Y1ZWExNDYxM2EwOWIwMzViNjNlOTE1MGE4ZTA0YWU0YTY4MjMzYzZjZjc2YTgxZjJjYTI3OGViM2RjYjE4ZGE4ZGUzZTc4Ng0KaGVhZGVyX3NpemU6IDY0MA0KdG90YWxfc2l6ZTogODM1Nw0KY29tcHV0ZWRfYm9keV9oYXNoOiBhN2ZmYzZmOGJmMWVkNzY2NTFjMTQ3NTZhMDYxZDY2MmY1ODBmZjRkZTQzYjQ5ZmE4MmQ4MGE0YjgwZjg0MzRhDQpBY2NlcHQ6ICovKg0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlLCBicg0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuMGIwDQpDb250ZW50LUxlbmd0aDogMTQ1OA0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "deny",
            "type": "deny",
            "reason": "Synapse name 'QnATask' not found, available ['Synapse', 'Score']",
            "synapse": "QnATask",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5Cqw3Gp3K2jLGBDdRFddT29gKL4xdRy65FUpaQbKUNPhsSQt",
            },
            "dendrite": {
                "ip": "192.150.253.122",
                "port": None,
                "hotkey": "5E2Wu8SspFHdKe1BRvfM5CpSxcjQfzpQxYKGVEYK52G4mbDv",
                "signature": "0xa40ca4198d98a7517c8ef9c587162c8578396a04480888d3990af4e3f5ea14613a09b035b63e9150a8e04ae4a68233c6cf76a81f2ca278eb3dcb18da8de3e786",
                "nonce": 258481542546094,
                "uuid": "1830e9b6-3d43-11ef-b4d7-e7b02bed2b57",
                "version": 720,
                "neuron_version": None,
            },
        },
        {
            "request_id": "c8aa5b82-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "c0383e88-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0048944950103759766,
            "notified": False,
            "current_time": 1720712808.5827734,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 44003,
            "flags": "S",
            "seq": 3603626340,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 4 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "cefbc48a-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "c8aa5b82-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0013756752014160156,
            "notified": False,
            "current_time": 1720712819.1817396,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 65314,
            "flags": "S",
            "seq": 1480162643,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-dos",
            "reason": "DoS attack detected: 5 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "d82821fc-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "cefbc48a-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0004985332489013672,
            "notified": False,
            "current_time": 1720712834.572815,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 37863,
            "flags": "S",
            "seq": 991842100,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-dos",
            "reason": "DoS attack detected: 5 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "e12f4f1e-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "1 None False",
            "process_time": 0.004770994186401367,
            "notified": False,
            "current_time": 1720712849.7192886,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41344,
            "flags": "S",
            "seq": 3762197367,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "e12f4f1e-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "2 None None",
            "process_time": 0.0010182857513427734,
            "notified": None,
            "current_time": 1720712850.3580303,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41344,
            "flags": "PA",
            "seq": 3762197368,
            "ack": 140930588,
            "payload": "UE9TVCAvU3luYXBzZSBIVFRQLzEuMQ0KSG9zdDogMTY3Ljg2Ljc5Ljg2OjgwOTENCm5hbWU6IFN5bmFwc2UNCnRpbWVvdXQ6IDUuMA0KYnRfaGVhZGVyX2F4b25faXA6IDE2Ny44Ni43OS44Ng0KYnRfaGVhZGVyX2F4b25fcG9ydDogODA5MQ0KYnRfaGVhZGVyX2F4b25faG90a2V5OiA1RVV5YWdidm5KUXdqRW1UbWRiaVZ0R3FQelZOeFpBcmVKQm9GeVRzWVNwV1g4eDENCmJ0X2hlYWRlcl9kZW5kcml0ZV9pcDogMTU4LjIyMC44Mi4xODENCmJ0X2hlYWRlcl9kZW5kcml0ZV92ZXJzaW9uOiA3MDAyMDAwDQpidF9oZWFkZXJfZGVuZHJpdGVfbm9uY2U6IDE3MjA3MTI4NTAzODY5NTk0MTINCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAwMGM0ZmNhMC0zZTE0LTExZWYtYThiZC0wN2QyZTVmOGRlOWENCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVEbmdOVXB2NWtTdmkxZ0Y1N0tZQ0VMZXpQVkhTQ3RkVWpzamdZclhFZ2RqVTRKYQ0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHgxZTliMjIyYjE2NTY2ZGQ1YWNhMDRlNzdjYzg5ZmQ4MTFhZmFmZGMzNzIwODg2NzBmYmJhZmNlZTNlODllNzRlYmU2ZWEwMmU1ODY3MzlhMDA1NWE4Mzk2MmM0MzRiNzk2M2YwM2NkNzI3ZjQ4Y2NmZDA4MDY3ZGM2ZDJlZGU4Ng0KYnRfaGVhZGVyX2RlbmRyaXRlX25ldXJvbl92ZXJzaW9uOiAyMjUNCmhlYWRlcl9zaXplOiA2NDANCnRvdGFsX3NpemU6IDM1MDcNCmNvbXB1dGVkX2JvZHlfaGFzaDogYTdmZmM2ZjhiZjFlZDc2NjUxYzE0NzU2YTA2MWQ2NjJmNTgwZmY0ZGU0M2I0OWZhODJkODBhNGI4MGY4NDM0YQ0KQWNjZXB0OiAqLyoNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuNQ0KQ29udGVudC1MZW5ndGg6IDc4OA0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": "Synapse",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5EUyagbvnJQwjEmTmdbiVtGqPzVNxZAreJBoFyTsYSpWX8x1",
            },
            "dendrite": {
                "ip": "158.220.82.181",
                "port": None,
                "hotkey": "5DngNUpv5kSvi1gF57KYCELezPVHSCtdUjsjgYrXEgdjU4Ja",
                "signature": "0x1e9b222b16566dd5aca04e77cc89fd811afafdc372088670fbbafcee3e89e74ebe6ea02e586739a0055a83962c434b7963f03cd727f48ccfd08067dc6d2ede86",
                "nonce": 1720712850386959412,
                "uuid": "00c4fca0-3e14-11ef-a8bd-07d2e5f8de9a",
                "version": 7002000,
                "neuron_version": 225,
            },
        },
        {
            "request_id": "e5142dde-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "e12f4f1e-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.005370616912841797,
            "notified": False,
            "current_time": 1720712856.2520642,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41346,
            "flags": "S",
            "seq": 2449863734,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "e5142dde-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "2 e12f4f1e-3f9c-11ef-b64f-9dc9db5f9ad8 None",
            "process_time": 0.0004966259002685547,
            "notified": None,
            "current_time": 1720712856.2849169,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41346,
            "flags": "PA",
            "seq": 2449863735,
            "ack": 1286610012,
            "payload": "UE9TVCAvU2NvcmUgSFRUUC8xLjENCkhvc3Q6IDE2Ny44Ni43OS44Njo4MDkxDQpuYW1lOiBTY29yZQ0KdGltZW91dDogNS4wDQpidF9oZWFkZXJfYXhvbl9pcDogMTY3Ljg2Ljc5Ljg2DQpidF9oZWFkZXJfYXhvbl9wb3J0OiA4MDkxDQpidF9oZWFkZXJfYXhvbl9ob3RrZXk6IDVFVXlhZ2J2bkpRd2pFbVRtZGJpVnRHcVB6Vk54WkFyZUpCb0Z5VHNZU3BXWDh4MQ0KYnRfaGVhZGVyX2RlbmRyaXRlX2lwOiAxNTguMjIwLjgyLjE4MQ0KYnRfaGVhZGVyX2RlbmRyaXRlX3ZlcnNpb246IDcwMDIwMDANCmJ0X2hlYWRlcl9kZW5kcml0ZV9ub25jZTogMTcyMDcxMjg1Njg0NDM2MTg2OQ0KYnRfaGVhZGVyX2RlbmRyaXRlX3V1aWQ6IDAwYzRmY2EwLTNlMTQtMTFlZi1hOGJkLTA3ZDJlNWY4ZGU5YQ0KYnRfaGVhZGVyX2RlbmRyaXRlX2hvdGtleTogNURuZ05VcHY1a1N2aTFnRjU3S1lDRUxlelBWSFNDdGRVanNqZ1lyWEVnZGpVNEphDQpidF9oZWFkZXJfZGVuZHJpdGVfc2lnbmF0dXJlOiAweGUwYmUwYzg3ZWZlYjJiMTg4YmI1ZjFlODZiNDFiMjJlMDJiYWE2MGRlZjY1MDVhNTc0OWY5OGFhMTE5YWZlNmMwODVjMTI4MGM3NzI3NjQ3OTQ2ZGJhMTEzMmMxZTY5N2MxZmE4ZjQxZDczZGYyZWNjYzRiODBhZWU2ZWJkNDhhDQpidF9oZWFkZXJfZGVuZHJpdGVfbmV1cm9uX3ZlcnNpb246IDIyNQ0KYnRfaGVhZGVyX2lucHV0X29ial9hdmFpbGFiaWxpdHk6IE1DNHcNCmJ0X2hlYWRlcl9pbnB1dF9vYmpfbGF0ZW5jeTogTUM0dw0KYnRfaGVhZGVyX2lucHV0X29ial9yZWxpYWJpbGl0eTogTUM0dw0KYnRfaGVhZGVyX2lucHV0X29ial9kaXN0cmlidXRpb246IE1DNHcNCmJ0X2hlYWRlcl9pbnB1dF9vYmpfc2NvcmU6IE1DNHcNCmhlYWRlcl9zaXplOiA2NDANCnRvdGFsX3NpemU6IDQzNjkNCmNvbXB1dGVkX2JvZHlfaGFzaDogYTdmZmM2ZjhiZjFlZDc2NjUxYzE0NzU2YTA2MWQ2NjJmNTgwZmY0ZGU0M2I0OWZhODJkODBhNGI4MGY4NDM0YQ0KQWNjZXB0OiAqLyoNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuNQ0KQ29udGVudC1MZW5ndGg6IDk1OQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": "Score",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5EUyagbvnJQwjEmTmdbiVtGqPzVNxZAreJBoFyTsYSpWX8x1",
            },
            "dendrite": {
                "ip": "158.220.82.181",
                "port": None,
                "hotkey": "5DngNUpv5kSvi1gF57KYCELezPVHSCtdUjsjgYrXEgdjU4Ja",
                "signature": "0xe0be0c87efeb2b188bb5f1e86b41b22e02baa60def6505a5749f98aa119afe6c085c1280c7727647946dba1132c1e697c1fa8f41d73df2eccc4b80aee6ebd48a",
                "nonce": 1720712856844361869,
                "uuid": "00c4fca0-3e14-11ef-a8bd-07d2e5f8de9a",
                "version": 7002000,
                "neuron_version": 225,
            },
        },
        {
            "request_id": "fea607ea-3f9c-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "d82821fc-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.003931999206542969,
            "notified": False,
            "current_time": 1720712899.1512277,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 16846,
            "flags": "S",
            "seq": 3497487705,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "06d2ce94-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "fea607ea-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0036406517028808594,
            "notified": False,
            "current_time": 1720712912.8666022,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 6858,
            "flags": "S",
            "seq": 2368761008,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "0c09b828-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "06d2ce94-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0044269561767578125,
            "notified": False,
            "current_time": 1720712921.6149933,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 33612,
            "flags": "S",
            "seq": 1155977555,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 3 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "146eeae2-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "0c09b828-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0044291019439697266,
            "notified": False,
            "current_time": 1720712935.6997137,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 4177,
            "flags": "S",
            "seq": 241697872,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 4 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "1a64b5c6-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "146eeae2-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0005245208740234375,
            "notified": False,
            "current_time": 1720712945.6993225,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 15846,
            "flags": "S",
            "seq": 2704057016,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-dos",
            "reason": "DoS attack detected: 5 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "22c5b8a0-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "1a64b5c6-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0004911422729492188,
            "notified": False,
            "current_time": 1720712959.756962,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 47125,
            "flags": "S",
            "seq": 1078730388,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-dos",
            "reason": "DoS attack detected: 5 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "461dc9b4-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "22c5b8a0-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.002919435501098633,
            "notified": False,
            "current_time": 1720713019.0545173,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 51457,
            "flags": "S",
            "seq": 2973923031,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "4e7625ca-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "461dc9b4-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0038521289825439453,
            "notified": False,
            "current_time": 1720713033.055184,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 64669,
            "flags": "S",
            "seq": 1463075912,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "8775f0f8-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "4e7625ca-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.004148244857788086,
            "notified": False,
            "current_time": 1720713128.6839883,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 36389,
            "flags": "S",
            "seq": 932632332,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "8fcef146-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "8775f0f8-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.00392913818359375,
            "notified": False,
            "current_time": 1720713142.6890934,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 54124,
            "flags": "S",
            "seq": 2703125806,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "bf13747c-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "e5142dde-3f9c-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.005536794662475586,
            "notified": False,
            "current_time": 1720713221.9907398,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41348,
            "flags": "S",
            "seq": 1430019529,
            "ack": 0,
            "payload": "",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "bf13747c-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "2 e5142dde-3f9c-11ef-b64f-9dc9db5f9ad8 None",
            "process_time": 0.0015239715576171875,
            "notified": None,
            "current_time": 1720713222.424523,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41348,
            "flags": "PA",
            "seq": 1430019530,
            "ack": 3188809988,
            "payload": "UE9TVCAvU3luYXBzZSBIVFRQLzEuMQ0KSG9zdDogMTY3Ljg2Ljc5Ljg2OjgwOTENCm5hbWU6IFN5bmFwc2UNCnRpbWVvdXQ6IDUuMA0KYnRfaGVhZGVyX2F4b25faXA6IDE2Ny44Ni43OS44Ng0KYnRfaGVhZGVyX2F4b25fcG9ydDogODA5MQ0KYnRfaGVhZGVyX2F4b25faG90a2V5OiA1RVV5YWdidm5KUXdqRW1UbWRiaVZ0R3FQelZOeFpBcmVKQm9GeVRzWVNwV1g4eDENCmJ0X2hlYWRlcl9kZW5kcml0ZV9pcDogMTU4LjIyMC44Mi4xODENCmJ0X2hlYWRlcl9kZW5kcml0ZV92ZXJzaW9uOiA3MDAyMDAwDQpidF9oZWFkZXJfZGVuZHJpdGVfbm9uY2U6IDE3MjA3MTMyMjI2NjY3MTc5MzgNCmJ0X2hlYWRlcl9kZW5kcml0ZV91dWlkOiAwMGM0ZmNhMC0zZTE0LTExZWYtYThiZC0wN2QyZTVmOGRlOWENCmJ0X2hlYWRlcl9kZW5kcml0ZV9ob3RrZXk6IDVEbmdOVXB2NWtTdmkxZ0Y1N0tZQ0VMZXpQVkhTQ3RkVWpzamdZclhFZ2RqVTRKYQ0KYnRfaGVhZGVyX2RlbmRyaXRlX3NpZ25hdHVyZTogMHgzNDIwODE5ODQ2OTUzODU5YjFjZmI1NjBkNjUwZDgwNjc1MTU4NTI1YTgxMjA1MTllNTNkNzkyNjJiM2I2OTNlNGI2NDljOGUxYjg0NDZmMDgxYWYxMDNmNjM0ZTBlNWFmNDVlZjJmM2M4Y2U5ZWRkNGFmZDk1YmY5ODU4MzI4OA0KYnRfaGVhZGVyX2RlbmRyaXRlX25ldXJvbl92ZXJzaW9uOiAyMjUNCmhlYWRlcl9zaXplOiA2NDANCnRvdGFsX3NpemU6IDM1MDcNCmNvbXB1dGVkX2JvZHlfaGFzaDogYTdmZmM2ZjhiZjFlZDc2NjUxYzE0NzU2YTA2MWQ2NjJmNTgwZmY0ZGU0M2I0OWZhODJkODBhNGI4MGY4NDM0YQ0KQWNjZXB0OiAqLyoNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KVXNlci1BZ2VudDogUHl0aG9uLzMuMTAgYWlvaHR0cC8zLjkuNQ0KQ29udGVudC1MZW5ndGg6IDc4OA0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uDQoNCg==",
            "status": "allow",
            "type": "allow",
            "reason": "Previous package: None None None:None:0:0:None",
            "synapse": "Synapse",
            "axon": {
                "ip": "167.86.79.86",
                "port": 8091,
                "hotkey": "5EUyagbvnJQwjEmTmdbiVtGqPzVNxZAreJBoFyTsYSpWX8x1",
            },
            "dendrite": {
                "ip": "158.220.82.181",
                "port": None,
                "hotkey": "5DngNUpv5kSvi1gF57KYCELezPVHSCtdUjsjgYrXEgdjU4Ja",
                "signature": "0x3420819846953859b1cfb560d650d80675158525a8120519e53d79262b3b693e4b649c8e1b8446f081af103f634e0e5af45ef2f3c8ce9edd4afd95bf98583288",
                "nonce": 1720713222666717938,
                "uuid": "00c4fca0-3e14-11ef-a8bd-07d2e5f8de9a",
                "version": 7002000,
                "neuron_version": 225,
            },
        },
        {
            "request_id": "c7925064-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "bf13747c-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.03201603889465332,
            "notified": False,
            "current_time": 1720713236.24408,
            "sip": "158.220.82.181",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 41350,
            "flags": "S",
            "seq": 3594441678,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "d314912c-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "8fcef146-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.0057103633880615234,
            "notified": False,
            "current_time": 1720713255.5528157,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 36250,
            "flags": "S",
            "seq": 638942103,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
        {
            "request_id": "db7ff766-3f9d-11ef-b64f-9dc9db5f9ad8",
            "previous_id": "d314912c-3f9d-11ef-b64f-9dc9db5f9ad8 1 False",
            "process_time": 0.004298210144042969,
            "notified": False,
            "current_time": 1720713269.678213,
            "sip": "192.150.253.122",
            "protocol": "tcp",
            "dip": "167.86.79.86",
            "dport": 8091,
            "sport": 3896,
            "flags": "S",
            "seq": 2304056399,
            "ack": 0,
            "payload": "",
            "status": "deny",
            "type": "detect-ddos",
            "reason": "DDoS attack detected: 2 requests in 300 seconds",
            "synapse": None,
            "axon": {"ip": None, "port": None, "hotkey": None},
            "dendrite": {
                "ip": None,
                "port": None,
                "hotkey": None,
                "signature": None,
                "nonce": None,
                "uuid": None,
                "version": None,
                "neuron_version": None,
            },
        },
    ]


def compute_process_time(items):
    # Check if there are at least 2 items
    if len(items) < 2:
        return ""

    # Sort the list based on current_time
    sorted_items = sorted(items, key=lambda x: x["current_time"])

    # Get the first and last times
    first_time = sorted_items[0]["current_time"]
    last_time = sorted_items[-1]["current_time"]

    # Compute the process time
    return last_time - first_time


# Route to serve the main page
@app.route("/")
def index():
    return render_template("firewall-monitor.html")


# Route to fetch the events
@app.route("/requests")
def get_requests():
    events = load_events()

    # Create a dictionary to group packets by request_id
    grouped_requests = defaultdict(list)

    # Group packets by request_id
    for packet in events:
        grouped_requests[packet["request_id"]].append(packet)

    # Create an array of requests with merged information
    merged_requests = []
    for request_id, packets in grouped_requests.items():
        status = "allow"
        notified = False
        reason = ""

        sync_packet = next((x for x in packets if x.get("flags") == "S"), None)
        if sync_packet is None:
            continue

        for packet in packets:
            if packet["status"] == "deny":
                status = "deny"
            if packet["notified"]:
                notified = True
            if packet["reason"]:
                reason = packet["reason"]

        merged_request = {
            "current_time": sync_packet.get("current_time"),
            "process_time": compute_process_time(packets),
            "request_id": request_id,
            "previous_id": sync_packet.get("previous_id"),
            "sip": sync_packet.get("sip"),
            "dip": sync_packet.get("dip"),
            "protocol": sync_packet.get("protocol"),
            "dport": sync_packet.get("dport"),
            "status": status,
            "notified": notified,
            "reason": reason,
            "flags": ",".join([x.get("flags") for x in packets]),
            "packets": packets,
        }
        merged_requests.append(merged_request)

    # Get all query parameters
    query_params = request.args.to_dict()

    # Filter events dynamically based on query parameters
    def match_request(request, filters):
        for key, value in filters.items():
            if key not in request or str(request[key]) != value:
                return False
        return True

    filtered_requests = [
        request for request in merged_requests if match_request(request, query_params)
    ]

    sorted_requests = sorted(
        filtered_requests, key=lambda x: x.get("current_time"), reverse=True
    )

    return jsonify(sorted_requests)


# Function to handle cleanup
def cleanup():
    tool = create_firewall_tool()
    tool.remove_rule(dport=8080, protocol="tcp", allow=True)


def signal_handler(sig, frame):
    cleanup()
    sys.exit(0)


if __name__ == "__main__":
    # Register signal handlers
    signal.signal(signal.SIGINT, signal_handler)  # Handle Ctrl+C
    signal.signal(signal.SIGTERM, signal_handler)  # Handle `pm2 stop` and `pm2 delete`

    try:
        if not DEVELOPMENT:
            tool = create_firewall_tool()

            # Create an ALLOW rule
            tool.create_allow_rule(dport=8080, protocol="tcp")

        app.run(host="0.0.0.0", port=8080)
    finally:
        if not DEVELOPMENT:
            cleanup()
